<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‹¤ ìë¦¬ë°°ì¹˜ ìƒì„±ê¸°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @media print {
            @page {
                size: A4 landscape;
                margin: 15mm;
            }
            body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <div id="app" class="p-8">
        <div class="max-w-6xl mx-auto">
            <!-- ì…ë ¥ ì˜ì—­ -->
            <div class="no-print mb-8 bg-white rounded-lg shadow-md p-6">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">êµì‹¤ ìë¦¬ë°°ì¹˜ ìƒì„±ê¸°</h1>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        í•™ìƒ ëª…ë‹¨ ì…ë ¥ (ë²ˆí˜¸ ì´ë¦„ í˜•ì‹ìœ¼ë¡œ ì…ë ¥, ì—‘ì…€ì—ì„œ ë³µì‚¬ ê°€ëŠ¥)
                    </label>
                    <textarea
                        id="studentInput"
                        class="w-full h-40 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ì˜ˆì‹œ:
1 ê¹€ì² ìˆ˜
2 ì´ì˜í¬
3 ë°•ë¯¼ìˆ˜"></textarea>
                    <button
                        onclick="registerStudents()"
                        class="mt-3 bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 transition">
                        ëª…ë‹¨ ë“±ë¡í•˜ê¸°
                    </button>
                    <div id="registerMessage" class="mt-2 text-sm text-green-700 font-medium hidden"></div>
                </div>

                <!-- ì‚¬ì „ ê³ ì • -->
                <div class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                    <h3 class="font-semibold text-gray-800 mb-3">ğŸ”’ ëœë¤ ë°°ì¹˜ ì „ íŠ¹ì • ìë¦¬ ê³ ì •í•˜ê¸°</h3>
                    
                    <div class="grid grid-cols-4 gap-3 mb-3">
                        <select id="studentSelect" class="col-span-2 p-2 border border-gray-300 rounded-md">
                            <option value="">í•™ìƒ ì„ íƒ</option>
                        </select>
                        <select id="rowSelect" class="p-2 border border-gray-300 rounded-md"></select>
                        <select id="colSelect" class="p-2 border border-gray-300 rounded-md"></select>
                    </div>

                    <button
                        onclick="addPreLock()"
                        class="bg-amber-600 text-white px-4 py-2 rounded-md hover:bg-amber-700 transition text-sm">
                        + ê³ ì • ì¶”ê°€
                    </button>

                    <div id="preLockList" class="mt-3 space-y-2 hidden"></div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">í–‰ ìˆ˜</label>
                        <input type="number" id="rowsInput" value="5" min="1" max="10" 
                               onchange="updateRowColSelects()"
                               class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">ì—´ ìˆ˜</label>
                        <input type="number" id="colsInput" value="6" min="1" max="10"
                               onchange="updateRowColSelects()"
                               class="w-full p-2 border border-gray-300 rounded-md">
                    </div>
                </div>

                <div class="flex flex-wrap gap-3">
                    <button onclick="randomizeSeating()" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition">
                        ğŸ”€ ëœë¤ ë°°ì¹˜
                    </button>
                    <button onclick="toggleView()" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition" id="viewBtn" disabled>
                        ğŸ”„ êµì‚¬ ì‹œì 
                    </button>
                    <button onclick="downloadPDF()" class="bg-purple-600 text-white px-6 py-3 rounded-md hover:bg-purple-700 transition" id="pdfBtn" disabled>
                        ğŸ“¥ PDF ë‹¤ìš´ë¡œë“œ
                    </button>
                    <button onclick="window.print()" class="bg-pink-600 text-white px-6 py-3 rounded-md hover:bg-pink-700 transition" id="printBtn" disabled>
                        ğŸ–¨ï¸ ì¸ì‡„
                    </button>
                    <button onclick="resetAll()" class="bg-gray-600 text-white px-6 py-3 rounded-md hover:bg-gray-700 transition">
                        ì´ˆê¸°í™”
                    </button>
                </div>

                <div id="tips" class="mt-4 space-y-2 hidden">
                    <div class="text-sm text-gray-600">ğŸ’¡ ì¢Œì„ì„ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
                    <div class="text-sm text-gray-600">ğŸ”’ ë°°ì¹˜ í›„ ìë¬¼ì‡  ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ ìë¦¬ë¥¼ ê³ ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.</div>
                </div>
            </div>

            <!-- ìë¦¬ë°°ì¹˜ë„ -->
            <div id="seatingChart" class="hidden bg-white rounded-lg shadow-md p-8 print:shadow-none print:p-0">
                <div class="no-print mb-4">
                    <h2 class="text-2xl font-bold text-gray-800" id="chartTitle">ìë¦¬ë°°ì¹˜ë„ (í•™ìƒ ì‹œì )</h2>
                </div>
                <div class="print-only mb-4">
                    <h2 class="text-2xl font-bold text-gray-800 text-center" id="chartTitlePrint">ìë¦¬ë°°ì¹˜ë„ (í•™ìƒ ì‹œì )</h2>
                </div>
                
                <div id="teacherDeskTop" class="flex justify-center mb-6 hidden">
                    <div class="bg-amber-100 border-2 border-amber-400 px-12 py-4 rounded-lg text-center font-bold text-gray-700">êµíƒ</div>
                </div>
                
                <div id="seatingGrid" class="flex flex-col gap-3 mb-6"></div>
                
                <div id="teacherDeskBottom" class="flex justify-center mt-6 hidden">
                    <div class="bg-amber-100 border-2 border-amber-400 px-12 py-4 rounded-lg text-center font-bold text-gray-700">êµíƒ</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let students = [];
        let seating = [];
        let preLockedStudents = [];
        let lockedSeats = [];
        let viewMode = 'student';
        let draggedFrom = null;

        function registerStudents() {
            const input = document.getElementById('studentInput').value.trim();
            const lines = input.split('\n');
            students = lines.map(line => {
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 2) {
                    return { number: parts[0], name: parts.slice(1).join(' ') };
                }
                return null;
            }).filter(s => s !== null);

            const msg = document.getElementById('registerMessage');
            if (students.length > 0) {
                msg.textContent = `âœ“ ${students.length}ëª…ì˜ í•™ìƒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤`;
                msg.classList.remove('hidden');
                updateStudentSelect();
            } else {
                alert('í•™ìƒ ëª…ë‹¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        }

        function updateStudentSelect() {
            const select = document.getElementById('studentSelect');
            select.innerHTML = '<option value="">í•™ìƒ ì„ íƒ</option>';
            students.forEach(s => {
                const option = document.createElement('option');
                option.value = s.number;
                option.textContent = `${s.number} ${s.name}`;
                select.appendChild(option);
            });
        }

        function updateRowColSelects() {
            const rows = parseInt(document.getElementById('rowsInput').value);
            const cols = parseInt(document.getElementById('colsInput').value);
            
            const rowSelect = document.getElementById('rowSelect');
            const colSelect = document.getElementById('colSelect');
            
            rowSelect.innerHTML = '';
            colSelect.innerHTML = '';
            
            for (let i = 0; i < rows; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i + 1}í–‰`;
                rowSelect.appendChild(option);
            }
            
            for (let i = 0; i < cols; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${i + 1}ì—´`;
                colSelect.appendChild(option);
            }
        }

        function addPreLock() {
            const studentNum = document.getElementById('studentSelect').value;
            if (!studentNum) {
                alert('í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const student = students.find(s => s.number === studentNum);
            const rowIdx = parseInt(document.getElementById('rowSelect').value);
            const colIdx = parseInt(document.getElementById('colSelect').value);

            if (preLockedStudents.some(p => p.student.number === studentNum)) {
                alert('ì´ë¯¸ ê³ ì •ëœ í•™ìƒì…ë‹ˆë‹¤.');
                return;
            }

            preLockedStudents.push({ student, rowIdx, colIdx });
            renderPreLockList();
        }

        function removePreLock(studentNum) {
            preLockedStudents = preLockedStudents.filter(p => p.student.number !== studentNum);
            renderPreLockList();
        }

        function renderPreLockList() {
            const list = document.getElementById('preLockList');
            if (preLockedStudents.length === 0) {
                list.classList.add('hidden');
                return;
            }

            list.classList.remove('hidden');
            list.innerHTML = '<div class="text-sm font-medium text-gray-700">ê³ ì •ëœ í•™ìƒ:</div>';
            preLockedStudents.forEach(pre => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-white p-2 rounded border border-amber-300';
                div.innerHTML = `
                    <span class="text-sm">${pre.student.number} ${pre.student.name} â†’ ${pre.rowIdx + 1}í–‰ ${pre.colIdx + 1}ì—´</span>
                    <button onclick="removePreLock('${pre.student.number}')" class="text-red-600 hover:text-red-800 text-sm font-medium">ì œê±°</button>
                `;
                list.appendChild(div);
            });
        }

        function randomizeSeating() {
            if (students.length === 0) {
                alert('í•™ìƒ ëª…ë‹¨ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.');
                return;
            }

            const rows = parseInt(document.getElementById('rowsInput').value);
            const cols = parseInt(document.getElementById('colsInput').value);

            seating = Array(rows).fill(null).map(() => Array(cols).fill(null));
            const usedStudents = new Set();
            const newLockedSeats = [];

            preLockedStudents.forEach(({ student, rowIdx, colIdx }) => {
                if (rowIdx < rows && colIdx < cols) {
                    seating[rowIdx][colIdx] = student;
                    usedStudents.add(student.number);
                    newLockedSeats.push({ rowIdx, colIdx });
                }
            });

            const availableStudents = students.filter(s => !usedStudents.has(s.number));
            const shuffled = [...availableStudents].sort(() => Math.random() - 0.5);

            let studentIndex = 0;
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    if (!seating[i][j] && studentIndex < shuffled.length) {
                        seating[i][j] = shuffled[studentIndex++];
                    }
                }
            }

            lockedSeats = newLockedSeats;
            renderSeating();
            
            document.getElementById('viewBtn').disabled = false;
            document.getElementById('pdfBtn').disabled = false;
            document.getElementById('printBtn').disabled = false;
            document.getElementById('tips').classList.remove('hidden');
        }

        function renderSeating() {
            const rows = parseInt(document.getElementById('rowsInput').value);
            const cols = parseInt(document.getElementById('colsInput').value);
            const grid = document.getElementById('seatingGrid');
            const chart = document.getElementById('seatingChart');
            
            chart.classList.remove('hidden');
            grid.innerHTML = '';

            const displaySeating = viewMode === 'teacher' 
                ? seating.map(row => [...row].reverse()).reverse() 
                : seating;

            displaySeating.forEach((row, rowIdx) => {
                const rowDiv = document.createElement('div');
                rowDiv.className = 'flex justify-center gap-3';

                row.forEach((student, colIdx) => {
                    const actualRowIdx = viewMode === 'teacher' ? rows - 1 - rowIdx : rowIdx;
                    const actualColIdx = viewMode === 'teacher' ? cols - 1 - colIdx : colIdx;
                    const locked = lockedSeats.some(l => l.rowIdx === actualRowIdx && l.colIdx === actualColIdx);

                    const cell = document.createElement('div');
                    cell.className = 'relative';
                    
                    const seatDiv = document.createElement('div');
                    seatDiv.draggable = student && !locked;
                    seatDiv.className = `w-28 h-20 border-2 rounded-lg flex flex-col items-center justify-center text-center transition ${
                        student
                            ? locked
                                ? 'bg-amber-50 border-amber-400 cursor-default'
                                : 'bg-blue-50 border-blue-300 cursor-move hover:bg-blue-100 hover:shadow-md'
                            : 'bg-gray-50 border-gray-200 border-dashed'
                    }`;

                    if (student) {
                        seatDiv.innerHTML = `
                            <div class="text-xs text-gray-500">${student.number}</div>
                            <div class="font-semibold text-gray-800">${student.name}</div>
                        `;

                        if (!locked) {
                            seatDiv.addEventListener('dragstart', () => {
                                draggedFrom = { rowIdx: actualRowIdx, colIdx: actualColIdx };
                            });
                        }

                        const lockBtn = document.createElement('button');
                        lockBtn.className = 'no-print absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md hover:shadow-lg transition border border-gray-300';
                        lockBtn.innerHTML = locked ? 'ğŸ”’' : 'ğŸ”“';
                        lockBtn.title = locked ? 'ê³ ì • í•´ì œ' : 'ìë¦¬ ê³ ì •';
                        lockBtn.onclick = () => toggleLock(actualRowIdx, actualColIdx);
                        cell.appendChild(lockBtn);
                    } else {
                        seatDiv.innerHTML = '<div class="text-gray-400 text-sm">ë¹ˆ ìë¦¬</div>';
                    }

                    seatDiv.addEventListener('dragover', (e) => e.preventDefault());
                    seatDiv.addEventListener('drop', () => {
                        if (draggedFrom && !locked) {
                            const temp = seating[actualRowIdx][actualColIdx];
                            seating[actualRowIdx][actualColIdx] = seating[draggedFrom.rowIdx][draggedFrom.colIdx];
                            seating[draggedFrom.rowIdx][draggedFrom.colIdx] = temp;
                            renderSeating();
                        }
                    });

                    cell.appendChild(seatDiv);
                    rowDiv.appendChild(cell);
                });

                grid.appendChild(rowDiv);
            });

            updateTeacherDesk();
        }

        function toggleLock(rowIdx, colIdx) {
            const index = lockedSeats.findIndex(l => l.rowIdx === rowIdx && l.colIdx === colIdx);
            if (index >= 0) {
                lockedSeats.splice(index, 1);
            } else {
                lockedSeats.push({ rowIdx, colIdx });
            }
            renderSeating();
        }

        function toggleView() {
            viewMode = viewMode === 'student' ? 'teacher' : 'student';
            document.getElementById('viewBtn').textContent = viewMode === 'student' ? 'ğŸ”„ êµì‚¬ ì‹œì ' : 'ğŸ”„ í•™ìƒ ì‹œì ';
            renderSeating();
        }

        function updateTeacherDesk() {
            const topDesk = document.getElementById('teacherDeskTop');
            const bottomDesk = document.getElementById('teacherDeskBottom');
            const title = document.getElementById('chartTitle');
            const titlePrint = document.getElementById('chartTitlePrint');

            if (viewMode === 'student') {
                topDesk.classList.remove('hidden');
                bottomDesk.classList.add('hidden');
                title.textContent = 'ìë¦¬ë°°ì¹˜ë„ (í•™ìƒ ì‹œì )';
                titlePrint.textContent = 'ìë¦¬ë°°ì¹˜ë„ (í•™ìƒ ì‹œì )';
            } else {
                topDesk.classList.add('hidden');
                bottomDesk.classList.remove('hidden');
                title.textContent = 'ìë¦¬ë°°ì¹˜ë„ (êµì‚¬ ì‹œì )';
                titlePrint.textContent = 'ìë¦¬ë°°ì¹˜ë„ (êµì‚¬ ì‹œì )';
            }
        }

        async function downloadPDF() {
            const element = document.getElementById('seatingChart');
            try {
                const canvas = await html2canvas(element, {
                    scale: 2,
                    backgroundColor: '#ffffff'
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                const imgX = (pdfWidth - imgWidth * ratio) / 2;
                const imgY = 10;

                pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
                pdf.save('ìë¦¬ë°°ì¹˜ë„.pdf');
            } catch (error) {
                console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
                alert('PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function resetAll() {
            students = [];
            seating = [];
            preLockedStudents = [];
            lockedSeats = [];
            viewMode = 'student';
            
            document.getElementById('studentInput').value = '';
            document.getElementById('registerMessage').classList.add('hidden');
            document.getElementById('seatingChart').classList.add('hidden');
            document.getElementById('tips').classList.add('hidden');
            document.getElementById('viewBtn').disabled = true;
            document.getElementById('pdfBtn').disabled = true;
            document.getElementById('printBtn').disabled = true;
            
            updateStudentSelect();
            renderPreLockList();
        }

        // ì´ˆê¸°í™”
        updateRowColSelects();
    </script>
</body>
</html>