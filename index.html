import React, { useState, useRef } from 'react';
import { Shuffle, Printer, RotateCcw, Lock, Unlock, Plus, Download } from 'lucide-react';

export default function ClassroomSeatingApp() {
  const [students, setStudents] = useState([]);
  const [inputText, setInputText] = useState('');
  const [rows, setRows] = useState(5);
  const [cols, setCols] = useState(6);
  const [seating, setSeating] = useState([]);
  const [preLockedStudents, setPreLockedStudents] = useState([]);
  const [lockedSeats, setLockedSeats] = useState([]);
  const [draggedStudent, setDraggedStudent] = useState(null);
  const [viewMode, setViewMode] = useState('student');
  const [selectedStudent, setSelectedStudent] = useState('');
  const [selectedRow, setSelectedRow] = useState(0);
  const [selectedCol, setSelectedCol] = useState(0);
  const printRef = useRef(null);

  const handleInputChange = (e) => {
    setInputText(e.target.value);
  };

  const processStudentList = () => {
    const lines = inputText.trim().split('\n');
    const studentList = lines.map(line => {
      const parts = line.trim().split(/\s+/);
      if (parts.length >= 2) {
        return {
          number: parts[0],
          name: parts.slice(1).join(' ')
        };
      }
      return null;
    }).filter(s => s !== null);
    
    setStudents(studentList);
    return studentList;
  };

  const addPreLockedStudent = () => {
    if (!selectedStudent) {
      alert('í•™ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }

    const studentList = students.length > 0 ? students : processStudentList();
    const student = studentList.find(s => s.number === selectedStudent);
    
    if (!student) {
      alert('í•™ìƒì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
      return;
    }

    const alreadyAdded = preLockedStudents.some(
      pre => pre.student.number === student.number
    );
    
    if (alreadyAdded) {
      alert('ì´ë¯¸ ê³ ì •ëœ í•™ìƒì…ë‹ˆë‹¤.');
      return;
    }

    setPreLockedStudents([
      ...preLockedStudents,
      {
        student,
        rowIdx: selectedRow,
        colIdx: selectedCol
      }
    ]);
    
    setSelectedStudent('');
  };

  const removePreLockedStudent = (studentNumber) => {
    setPreLockedStudents(
      preLockedStudents.filter(pre => pre.student.number !== studentNumber)
    );
  };

  const isLocked = (rowIdx, colIdx) => {
    return lockedSeats.some(lock => lock.rowIdx === rowIdx && lock.colIdx === colIdx);
  };

  const toggleLock = (rowIdx, colIdx) => {
    if (!seating[rowIdx][colIdx]) return;

    const locked = isLocked(rowIdx, colIdx);
    if (locked) {
      setLockedSeats(lockedSeats.filter(
        lock => !(lock.rowIdx === rowIdx && lock.colIdx === colIdx)
      ));
    } else {
      setLockedSeats([...lockedSeats, { rowIdx, colIdx }]);
    }
  };

  const randomizeSeating = () => {
    const studentList = students.length > 0 ? students : processStudentList();
    if (studentList.length === 0) {
      alert('í•™ìƒ ëª…ë‹¨ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const newSeating = Array(rows).fill(null).map(() => Array(cols).fill(null));
    const usedStudents = new Set();
    const newLockedSeats = [];

    preLockedStudents.forEach(({ student, rowIdx, colIdx }) => {
      if (rowIdx < rows && colIdx < cols) {
        newSeating[rowIdx][colIdx] = student;
        usedStudents.add(student.number);
        newLockedSeats.push({ rowIdx, colIdx });
      }
    });

    lockedSeats.forEach(({ rowIdx, colIdx }) => {
      if (seating[rowIdx] && seating[rowIdx][colIdx] && !newSeating[rowIdx][colIdx]) {
        const student = seating[rowIdx][colIdx];
        newSeating[rowIdx][colIdx] = student;
        usedStudents.add(student.number);
        newLockedSeats.push({ rowIdx, colIdx });
      }
    });

    const availableStudents = studentList.filter(
      student => !usedStudents.has(student.number)
    );
    const shuffled = [...availableStudents].sort(() => Math.random() - 0.5);
    
    let studentIndex = 0;
    for (let i = 0; i < rows; i++) {
      for (let j = 0; j < cols; j++) {
        if (!newSeating[i][j] && studentIndex < shuffled.length) {
          newSeating[i][j] = shuffled[studentIndex];
          studentIndex++;
        }
      }
    }
    
    setSeating(newSeating);
    setLockedSeats(newLockedSeats);
  };

  const handleDragStart = (student, rowIdx, colIdx) => {
    if (isLocked(rowIdx, colIdx)) return;
    setDraggedStudent({ student, rowIdx, colIdx });
  };

  const handleDragOver = (e) => {
    e.preventDefault();
  };

  const handleDrop = (targetRowIdx, targetColIdx) => {
    if (!draggedStudent) return;
    if (isLocked(targetRowIdx, targetColIdx)) return;

    const newSeating = seating.map(row => [...row]);
    const { student, rowIdx, colIdx } = draggedStudent;
    
    const targetStudent = newSeating[targetRowIdx][targetColIdx];
    newSeating[targetRowIdx][targetColIdx] = student;
    newSeating[rowIdx][colIdx] = targetStudent;
    
    setSeating(newSeating);
    setDraggedStudent(null);
  };

  const handleDownloadPDF = async () => {
    const element = printRef.current;
    if (!element) return;

    try {
      const html2canvas = (await import('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js')).default;
      const jsPDFModule = await import('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      const jsPDF = jsPDFModule.jsPDF;

      const canvas = await html2canvas(element, {
        scale: 2,
        backgroundColor: '#ffffff',
        logging: false
      });

      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
      });

      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const imgWidth = canvas.width;
      const imgHeight = canvas.height;
      const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
      const imgX = (pdfWidth - imgWidth * ratio) / 2;
      const imgY = 10;

      pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
      pdf.save('ìë¦¬ë°°ì¹˜ë„.pdf');
    } catch (error) {
      console.error('PDF ìƒì„± ì˜¤ë¥˜:', error);
      alert('PDF ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì¸ì‡„ ê¸°ëŠ¥(Ctrl+P)ì„ ì‚¬ìš©í•´ì£¼ì„¸ìš”.');
    }
  };

  const handlePrint = () => {
    window.print();
  };

  const handleReset = () => {
    setInputText('');
    setStudents([]);
    setSeating([]);
    setLockedSeats([]);
    setPreLockedStudents([]);
  };

  const displaySeating = viewMode === 'teacher' 
    ? [...seating].reverse().map(row => [...row].reverse()) 
    : seating;
  
  const studentList = students.length > 0 ? students : [];

  return (
    <div className="min-h-screen bg-gray-50 p-8">
      <div className="max-w-6xl mx-auto print:max-w-none">
        <div className="print:hidden mb-8 bg-white rounded-lg shadow-md p-6">
          <h1 className="text-3xl font-bold text-gray-800 mb-6">êµì‹¤ ìë¦¬ë°°ì¹˜ ìƒì„±ê¸°</h1>
          
          <div className="mb-6">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              í•™ìƒ ëª…ë‹¨ ì…ë ¥ (ë²ˆí˜¸ ì´ë¦„ í˜•ì‹ìœ¼ë¡œ ì…ë ¥, ì—‘ì…€ì—ì„œ ë³µì‚¬ ê°€ëŠ¥)
            </label>
            <textarea
              className="w-full h-40 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="ì˜ˆì‹œ:
1 ê¹€ì² ìˆ˜
2 ì´ì˜í¬
3 ë°•ë¯¼ìˆ˜"
              value={inputText}
              onChange={handleInputChange}
            />
            <button
              onClick={() => {
                processStudentList();
                alert('í•™ìƒ ëª…ë‹¨ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
              }}
              className="mt-3 bg-indigo-600 text-white px-5 py-2 rounded-md hover:bg-indigo-700 transition"
            >
              ëª…ë‹¨ ë“±ë¡í•˜ê¸°
            </button>
            {students.length > 0 && (
              <div className="mt-2 text-sm text-green-700 font-medium">
                âœ“ {students.length}ëª…ì˜ í•™ìƒì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤
              </div>
            )}
          </div>

          <div className="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
            <h3 className="font-semibold text-gray-800 mb-3">ğŸ”’ ëœë¤ ë°°ì¹˜ ì „ íŠ¹ì • ìë¦¬ ê³ ì •í•˜ê¸°</h3>
            
            <div className="grid grid-cols-4 gap-3 mb-3">
              <select
                value={selectedStudent}
                onChange={(e) => setSelectedStudent(e.target.value)}
                className="col-span-2 p-2 border border-gray-300 rounded-md"
                disabled={studentList.length === 0}
              >
                <option value="">í•™ìƒ ì„ íƒ</option>
                {studentList.map(s => (
                  <option key={s.number} value={s.number}>
                    {s.number} {s.name}
                  </option>
                ))}
              </select>
              
              <select
                value={selectedRow}
                onChange={(e) => setSelectedRow(parseInt(e.target.value))}
                className="p-2 border border-gray-300 rounded-md"
              >
                {Array.from({ length: rows }, (_, i) => (
                  <option key={i} value={i}>{i + 1}í–‰</option>
                ))}
              </select>
              
              <select
                value={selectedCol}
                onChange={(e) => setSelectedCol(parseInt(e.target.value))}
                className="p-2 border border-gray-300 rounded-md"
              >
                {Array.from({ length: cols }, (_, i) => (
                  <option key={i} value={i}>{i + 1}ì—´</option>
                ))}
              </select>
            </div>

            <button
              onClick={addPreLockedStudent}
              className="flex items-center gap-2 bg-amber-600 text-white px-4 py-2 rounded-md hover:bg-amber-700 transition text-sm"
              disabled={studentList.length === 0}
            >
              <Plus size={16} />
              ê³ ì • ì¶”ê°€
            </button>

            {preLockedStudents.length > 0 && (
              <div className="mt-3 space-y-2">
                <div className="text-sm font-medium text-gray-700">ê³ ì •ëœ í•™ìƒ:</div>
                {preLockedStudents.map((pre) => (
                  <div
                    key={pre.student.number}
                    className="flex items-center justify-between bg-white p-2 rounded border border-amber-300"
                  >
                    <span className="text-sm">
                      {pre.student.number} {pre.student.name} â†’ {pre.rowIdx + 1}í–‰ {pre.colIdx + 1}ì—´
                    </span>
                    <button
                      onClick={() => removePreLockedStudent(pre.student.number)}
                      className="text-red-600 hover:text-red-800 text-sm font-medium"
                    >
                      ì œê±°
                    </button>
                  </div>
                ))}
              </div>
            )}
          </div>

          <div className="grid grid-cols-2 gap-4 mb-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">í–‰ ìˆ˜</label>
              <input
                type="number"
                min="1"
                max="10"
                value={rows}
                onChange={(e) => setRows(parseInt(e.target.value) || 1)}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">ì—´ ìˆ˜</label>
              <input
                type="number"
                min="1"
                max="10"
                value={cols}
                onChange={(e) => setCols(parseInt(e.target.value) || 1)}
                className="w-full p-2 border border-gray-300 rounded-md"
              />
            </div>
          </div>

          <div className="flex flex-wrap gap-3">
            <button
              onClick={randomizeSeating}
              className="flex items-center gap-2 bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 transition"
            >
              <Shuffle size={20} />
              ëœë¤ ë°°ì¹˜
            </button>
            
            <button
              onClick={() => setViewMode(viewMode === 'student' ? 'teacher' : 'student')}
              className="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 transition"
              disabled={seating.length === 0}
            >
              <RotateCcw size={20} />
              {viewMode === 'student' ? 'êµì‚¬ ì‹œì ' : 'í•™ìƒ ì‹œì '}
            </button>

            <button
              onClick={handleDownloadPDF}
              className="flex items-center gap-2 bg-purple-600 text-white px-6 py-3 rounded-md hover:bg-purple-700 transition"
              disabled={seating.length === 0}
            >
              <Download size={20} />
              PDF ë‹¤ìš´ë¡œë“œ
            </button>

            <button
              onClick={handlePrint}
              className="flex items-center gap-2 bg-pink-600 text-white px-6 py-3 rounded-md hover:bg-pink-700 transition"
              disabled={seating.length === 0}
            >
              <Printer size={20} />
              ì¸ì‡„
            </button>

            <button
              onClick={handleReset}
              className="flex items-center gap-2 bg-gray-600 text-white px-6 py-3 rounded-md hover:bg-gray-700 transition"
            >
              ì´ˆê¸°í™”
            </button>
          </div>

          {seating.length > 0 && (
            <div className="mt-4 space-y-2">
              <div className="text-sm text-gray-600">
                ğŸ’¡ ì¢Œì„ì„ ë“œë˜ê·¸í•˜ì—¬ ìœ„ì¹˜ë¥¼ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </div>
              <div className="text-sm text-gray-600">
                ğŸ”’ ë°°ì¹˜ í›„ ìë¬¼ì‡  ì•„ì´ì½˜ì„ í´ë¦­í•˜ì—¬ ìë¦¬ë¥¼ ê³ ì •í•  ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
              </div>
            </div>
          )}
        </div>

        {seating.length > 0 && (
          <div ref={printRef} className="bg-white rounded-lg shadow-md p-8 print:shadow-none print:p-0">
            <div className="print:hidden mb-4">
              <h2 className="text-2xl font-bold text-gray-800">
                ìë¦¬ë°°ì¹˜ë„ ({viewMode === 'student' ? 'í•™ìƒ ì‹œì ' : 'êµì‚¬ ì‹œì '})
              </h2>
            </div>

            <div className="hidden print:block mb-4">
              <h2 className="text-2xl font-bold text-gray-800 text-center">
                ìë¦¬ë°°ì¹˜ë„ ({viewMode === 'student' ? 'í•™ìƒ ì‹œì ' : 'êµì‚¬ ì‹œì '})
              </h2>
            </div>

            {viewMode === 'student' && (
              <div className="flex justify-center mb-6">
                <div className="bg-amber-100 border-2 border-amber-400 px-12 py-4 rounded-lg text-center font-bold text-gray-700">
                  êµíƒ
                </div>
              </div>
            )}

            <div className="flex flex-col gap-3 mb-6">
              {displaySeating.map((row, rowIdx) => (
                <div key={rowIdx} className="flex justify-center gap-3">
                  {row.map((student, colIdx) => {
                    const actualRowIdx = viewMode === 'teacher' ? rows - 1 - rowIdx : rowIdx;
                    const actualColIdx = viewMode === 'teacher' ? cols - 1 - colIdx : colIdx;
                    const locked = isLocked(actualRowIdx, actualColIdx);
                    return (
                      <div key={colIdx} className="relative">
                        <div
                          draggable={student !== null && !locked}
                          onDragStart={() => handleDragStart(student, actualRowIdx, actualColIdx)}
                          onDragOver={handleDragOver}
                          onDrop={() => handleDrop(actualRowIdx, actualColIdx)}
                          className={`w-28 h-20 border-2 rounded-lg flex flex-col items-center justify-center text-center transition ${
                            student
                              ? locked
                                ? 'bg-amber-50 border-amber-400 cursor-default'
                                : 'bg-blue-50 border-blue-300 cursor-move hover:bg-blue-100 hover:shadow-md'
                              : 'bg-gray-50 border-gray-200 border-dashed'
                          }`}
                        >
                          {student ? (
                            <>
                              <div className="text-xs text-gray-500">{student.number}</div>
                              <div className="font-semibold text-gray-800">{student.name}</div>
                            </>
                          ) : (
                            <div className="text-gray-400 text-sm">ë¹ˆ ìë¦¬</div>
                          )}
                        </div>
                        
                        {student && (
                          <button
                            onClick={() => toggleLock(actualRowIdx, actualColIdx)}
                            className="print:hidden absolute -top-2 -right-2 bg-white rounded-full p-1 shadow-md hover:shadow-lg transition border border-gray-300"
                            title={locked ? 'ê³ ì • í•´ì œ' : 'ìë¦¬ ê³ ì •'}
                          >
                            {locked ? (
                              <Lock size={14} className="text-amber-600" />
                            ) : (
                              <Unlock size={14} className="text-gray-400" />
                            )}
                          </button>
                        )}
                      </div>
                    );
                  })}
                </div>
              ))}
            </div>

            {viewMode === 'teacher' && (
              <div className="flex justify-center mt-6">
                <div className="bg-amber-100 border-2 border-amber-400 px-12 py-4 rounded-lg text-center font-bold text-gray-700">
                  êµíƒ
                </div>
              </div>
            )}
          </div>
        )}
      </div>

      <style>{`
        @media print {
          @page {
            size: A4 landscape;
            margin: 15mm;
          }
          body {
            print-color-adjust: exact;
            -webkit-print-color-adjust: exact;
          }
        }
      `}</style>
    </div>
  );
}